# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

Программа реализует систему детектирования транспортных средств на изображениях с использованием трех современных архитектур нейронных сетей через OpenCV DNN. Проект включает полный цикл обработки: от загрузки моделей до вычисления метрик качества и визуализации результатов.

## Алгоритмы детектирования транспортных средств

### Алгоритм YOLOv4 и YOLOv4-tiny
1. **Предобработка изображения**

 - Изменение размера до 416×416 пикселей
 - Нормализация значений пикселей: $x = \frac{x}{255.0}$
 - Конвертация цвета из BGR в RGB
 - Формирование blob с параметром swapRB=True

 2. **Инференс**
 - Прямой проход через сеть Darknet
 - Получение предсказаний на нескольких масштабах

 3. **Постобработка**
 - Извлечение координат центра, ширины и высоты bounding box
 - Вычисление уверенности класса: $confidence = \max(scores)$
 - Фильтрация по порогу уверенности $\tau_{conf}$
 - Преобразование координат: $$x_1 = center_x - \frac{w}{2}, \quad y_1 = center_y - \frac{h}{2},$$  $$x_2 = x_1 + w, \quad y_2 = y_1 + h$$
 - Применение Non-Maximum Suppression (NMS) с порогом 0.4 для удаления дубликатов
 - Масштабирование координат к оригинальному размеру изображения

### SSD с backbone MobileNet
1. **Предобработка**
 - Изменение размера до 300×300
 - Нормализация: вычитание среднего (127.5, 127.5, 127.5) и масштабирование 1/127.5
 - Формирование blob

2. **Инференс**
 - Проход через MobileNet + дополнительные слои детекции

3. **Постобработка**
 - Извлечение детекций из единственного выходного тензора
 - Фильтрация по порогу уверенности $\tau_{conf}$
 - Преобразование нормализованных координат [0,1] в пиксельные: $x = x_{norm} \cdot w, \quad y = y_{norm} \cdot h$

## Метрики качества
### Матрица ошибок
|               | Предсказывает: объект | Предсказывает: фон |
|---------------|------------------------|---------------------|
| **Есть объект** | TP (True Positive)     | FN (False Negative) |
| **Нет объекта** | FP (False Positive)    | TN (True Negative)  |


Обозначения:

 - TP — правильно найденный объект (IoU ≥ порог и совпадение класса)
 - FP — ложная детекция
 - FN — пропущенный реальный объект
 - TN — корректно определённый фон (не учитывается в метриках детекции)


## Формулы метрик
$$TPR = \frac{TP}{TP + FN}$$ (True Positive Rate / Recall) — полнота

$$FDR = \frac{FP}{TP + FP}$$ (False Discovery Rate) — доля ложных находок

$$IoU(A,B) = \frac{|A \cap B|}{|A \cup B|} = \frac{|A \cap B|}{|A| + |B| - |A \cap B|}$$ — Intersection over Union

Сопоставление предсказаний и ground truth выполняется жадно: детекции сортируются по уверенности, каждому объекту разметки назначается лучшая подходящая детекция того же класса.

## Пример запуска приложения
```bash
# Сначала скачиваем модели (один раз)
python download_models.py

# Запуск детекции и оценки метрик
python main.py \
  --images_dir data/images \
  --annotation_file data/annotations.txt \
  --model yolo \
  --confidence 0.3 \
  --iou_threshold 0.45 \
  --display
```

Другие варианты модели: --model ssd_mobilenet или --model yolo_tiny

### Основные параметры:

 - `--images_dir` — директория с изображениями (jpg/png)
 - `--annotation_file` — файл аннотаций
 - `--model` — выбор модели (yolo, yolo_tiny, ssd_mobilenet)
 - `--confidence` — порог уверенности (по умолчанию 0.3)
 - `--iou_threshold` — порог IoU для оценки (по умолчанию 0.45)
 - `--display` — визуализация результатов в окне OpenCV (детекции цветными рамками, ground truth — жёлтыми)
 - `--frame_limit` — ограничение количества обрабатываемых кадров

## Результаты:
Датасет: 3456 изображений, confidence_threshold = 0.3, iou_threshold = 0.45

|     Модель    | Global TPR | Global FDR |  TPR |  FDR |  FN |
|---------------|------------|------------|------------|------------|------------|
| **YOLOv4** | 0.9566 | 0.3177 | 19412 | 9038 | 880 | 
| **YOLOv4YOLOv4-tiny** | 0.8885 | 0.1710 | 18029 | 3719 | 2263 | 
| **SSD MobileNet** | 0.8219 | 0.0528 | 16679 | 930 | 3613 | 

### Сравнение результатов моделей

**YOLOv4**: максимальная полнота (TPR = 0.9566), но высокий уровень ложных срабатываний (FDR = 0.3177).

**YOLOv4-tiny**: хороший баланс (TPR = 0.8885, FDR = 0.1710), подходит для ограниченных ресурсов.

**SSD MobileNet**: минимальное количество ложных детекций (FDR = 0.0528) при приемлемой полноте (TPR = 0.8219).

SSD MobileNet является наиболее подходящей моделью для задач, где важно минимизировать ложные срабатывания. YOLOv4 оптимален при необходимости максимальной полноты, а YOLOv4-tiny — при ограничениях по производительности.

## Выводы
 - В ходе работы реализована система детектирования транспортных средств с использованием OpenCV DNN и трёх предобученных моделей: YOLOv4, YOLOv4-tiny и SSD MobileNet.
 - Обеспечена модульная архитектура с базовым классом BaseDetector, отдельными детекторами, модулями метрик и визуализации.
Реализована предобработка, постобработка (включая NMS для YOLO), загрузка моделей и обработка аннотаций.
Проведена оценка на датасете из 3456 изображений (confidence = 0.3, IoU = 0.45).
