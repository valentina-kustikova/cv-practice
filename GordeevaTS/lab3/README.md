# Лабораторная работа №3. Классификация изображений с использованием библиотеки OpenCV

## Постановка задачи

**Цель работы** — разработать приложение для классификации изображений достопримечательностей Нижнего Новгорода и сравнить два подхода:
 - Метод «мешка визуальных слов» (Bag of Visual Words)
 - Нейросетевой подход с извлечением признаков и классическими ML-алгоритмами

**Классы для классификации:**
 - Нижегородский Кремль
 - Дворец труда
 - Архангельский собор


## Методы, их преимущества и недостатки
**Bag of Visual Words**

Метод "Мешка визуальных слов" представляет собой классический подход компьютерного зрения, основанный на аналогии с 
текстовым анализом. Сначала алгоритм SIFT находит на изображениях ключевые точки: углы и характерные области, 
устойчивые к изменениям масштаба и поворота. Для каждой точки вычисляется числовой дескриптор, описывающий её окружение. 
Все дескрипторы со всех изображений группируются в кластеры методом K-means, создавая "визуальный словарь". Каждое 
изображение затем преобразуется в гистограмму, показывающую частоту использования каждого "слова" из словаря. Эти 
гистограммы служат основой для обучения SVM-классификатора.

*Преимущества:*
 - Инвариантность к масштабу и повороту
 - Хорошая интерпретируемость
 - Не требует GPU
 - Эффективен на небольших датасетах

*Недостатки:*
 - Не учитывает пространственные связи
 - Требует ручного выбора детектора
 - Меньшая точность по сравнению с глубокими сетями
 - Чувствительность к качеству детектирования признаков


**Transfer Learning с ResNet50**

Этот подход использует предобученную сверточную нейронную сеть ResNet50, обученную на наборе данных ImageNet. Архитектура ResNet с остаточными связями позволяет эффективно обучать очень глубокие сети. В данном решении используется техника transfer learning: базовые слои ResNet50 замораживаются, а последний полносвязный слой заменяется на новый, адаптированный под нашу задачу классификации 3 классов. Это позволяет использовать мощные признаки, извлеченные на большом датасете, и дообучить модель на наших данных.

*Преимущества:*
 - Автоматическое извлечение высокоуровневых признаков
 - Высокая точность (благодаря предобучению)
 - Современное качество классификации

*Недостатки:*
 - Меньшая интерпретируемость
 - Зависимость от качества предобученной модели


## Реализация решений
### 1) BoW (Bag of Words - Мешок слов)

**Обучение**
1. Детектирование ключевых точек на всех тренировочных изображениях с помощью SIFT-детектора
2. Извлечение 128-мерных дескрипторов для найденных ключевых точек
3. Построение визуального словаря: кластеризация всех дескрипторов методом K-means
4. Векторизация тренировочных изображений: построение гистограмм частот визуальных слов для каждого изображения
5. Обучение SVM-классификатора с линейным ядром на полученных гистограммах
6. Сохранение словаря и обученного SVM

**Тестирование**
1. Загрузка сохранённого визуального словаря и SVM-модели
2. Детектирование ключевых точек и извлечение дескрипторов на тестовых изображениях
3. Векторизация тестовых изображений в гистограммы на основе загруженного словаря
4. Классификация каждого изображения с помощью SVM
5. Вычисление и вывод метрик точности (accuracy, confusion matrix и т.д.)

### 2) NN (Transfer Learning с ResNet50)

**Обучение**
1. Предобработка изображений: resize до 256px, center crop до 224×224, нормализация по средним и std ImageNet
2. Загрузка предобученной модели ResNet50 с весами IMAGENET1K_V1
3. Заморозка всех базовых слоёв
4. Замена последнего полносвязного слоя на новый с 3 выходами
5. Обучение только нового классификационного слоя на заданное число эпох
6. Сохранение дообученной модели

**Тестирование**
1. Загрузка сохранённой дообученной модели ResNet50
2. Предобработка тестовых изображений (аналогично обучению)
3. Прямой проход через сеть для получения предсказаний
4. Вычисление и вывод метрик точности (accuracy, confusion matrix и т.д.)

## Использование программы
**Базовые параметры:**
 - `--data_path`: Путь к директории с данными
 - `--train_split`: Файл с тренировочной выборкой
 - `--test_split`: Файл с тестовой выборкой
 - `--algorithm {bow|nn}`: Выбор алгоритма
 - `--mode {train|test|both}`: Режим работы
 - `--model_path`: Путь для сохранения/загрузки моделей
 - `--model_name`: Конкретное имя модели для загрузки

**Запуск Bag of Words:**
```bash
# Обучение модели:
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm bow --detector SIFT --vocab_size 50 --visualize_keypoints --max_keypoints 100

# Тестирование последней модели:
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm bow --mode test

# Тестирование конкретной модели:
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm bow --mode test --model_name bow_SIFT_vocab50_20251119_002702
```

**Запуск нейросетевого классификатора:**
```bash
# Обучение и тестирование:
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm nn --epochs 15 --batch_size 32

# Тестирование последней модели:
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm nn --mode test

# Тестирование конкретной модели:
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm nn --mode test --model_name nn_resnet_20251119_002702
```

## Сравнение методов
Результаты были получены при следующих запусках:

**Bag of Words:** 
```bash
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm bow --mode both --visualize_predictions --max_predictions 20

python main.py --mode test --algorithm bow --data_path ./data --train_split data/train.txt --test_split data/test.txt  --visualize_keypoints --max_keypoints 50 --model_path models --model_name bow_SIFT_vocab50_20251124_224329
```
**NN с ResNet50:**
```bash
python main.py --data_path ./data --train_split data/train.txt --test_split data/test.txt --algorithm nn --mode both --epochs 15 --batch_size 32 --lr 0.001

python main.py --mode test --algorithm nn --data_path ./data --train_split data/train.txt --test_split data/test.txt --model_path models --model_name nn_resnet_20251119_002702
```

### Результаты

|Метод|Точность|
|---|---|
|Bag of Visual Words |**0.9659**|
|Transfer Learning (CNN)|**0.9886**|


## Выводы и результаты
**В ходе работы было выполнено следующее:**
 - Реализован метод мешка визуальных слов для классификации изображений
 - Реализован нейросетевой подход с transfer learning на основе ResNet50
 - Реализована визуализация ключевых точек для BOW метода
 - Проведено сравнение эффективности методов

**Основные выводы**
 - Transfer Learning демонстрирует более высокую точность благодаря использованию предобученных признаков
 - BOW метод показывает хорошие результаты и обеспечивает лучшую интерпретируемость за счет визуализации ключевых точек
 - Оба подхода эффективны для задачи классификации архитектурных объектов
