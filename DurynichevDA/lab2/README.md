# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

## Цель работы
Создать приложение на Python для обнаружения транспортных средств на последовательности кадров видео с помощью готовых нейронных сетей из OpenCV DNN. Приложение реализует иерархию классов детекторов, сравнивает результаты с разметкой (Ground Truth), вычисляет метрики качества TPR и FDR, а также визуализирует предсказания.

---
## Структура проекта
```
DurynichevDA/
└── lab2/
    ├── detectors.py      # Классы детекторов с поддержкой разных моделей
    ├── evaluate.py       # Расчёт IoU и метрик за кадр
    ├── main.py           # Основной скрипт: загрузка данных, обработка, визуализация и вывод метрик
    ├── README.md         # Документация и отчёт
    ├── data/
    │   └── MOV03478/     # Кадры видео и файл разметки
    │       ├── mov03478.txt
    │       ├── 000000.jpg
    │       └── ...
    └── models/           # Файлы моделей
        ├── ssd/
        │   ├── MobileNetSSD_deploy.prototxt.txt
        │   └── MobileNetSSD_deploy.caffemodel
        └── yolo/
            ├── yolov3.cfg
            ├── yolov3.weights
            └── coco.names
```

---
## Архитектура приложения
Проект построен с использованием принципов объектно-ориентированного программирования и разделения ответственности.

### Основные компоненты
1. **`detectors.py`**  
   - Абстрактный базовый класс `Detector` с методом `detect`.  
   - Конкретные детекторы:  
     - `SSDDetector` — работа с MobileNet-SSD (формат Caffe).  
     - `YOLODetector` — работа с YOLOv3 (формат Darknet).  
   - Каждый класс самостоятельно выполняет предобработку, инференс и постобработку (фильтрация классов и NMS).

2. **`evaluate.py`**  
   - Функция расчёта IoU между двумя bounding box.  
   - Функция подсчёта TP, FP, FN для одного кадра.

3. **`main.py`**  
   - Парсинг аргументов командной строки.  
   - Загрузка ground truth из текстового файла.  
   - Инициализация выбранного детектора.  
   - Обработка всех кадров, накопление статистики и вывод итоговых метрик.  
   - Опциональная визуализация результатов.

---
## Реализованные алгоритмы предобработки и постобработки

### 1. MobileNet-SSD
Быстрая и лёгкая модель, хорошо подходящая для устройств с ограниченными ресурсами.

- **Предобработка:**  
  Входное изображение масштабируется до 300×300, применяется коэффициент 0.007843 и вычитается среднее (127.5, 127.5, 127.5).

- **Постобработка:**  
  Извлечение bounding box, фильтрация по порогу уверенности, отбор только транспортных классов (car, bus, truck, motorbike), применение NMS.

### 2. YOLOv3
Более точная модель с backbone Darknet-53.

- **Предобработка:**  
  Изображение приводится к размеру 416×416, нормализуется делением на 255, выполняется swapRB (BGR → RGB).

- **Постобработка:**  
  Декодирование предсказаний (центр + ширина/высота), выбор класса с максимальной вероятностью, фильтрация по транспортным классам, применение NMS.

---
## Расчёт метрик качества
Для оценки используется IoU с порогом 0.5.

- **TPR (Recall / Полнота):**  
  $$ TPR = \frac{TP}{TP + FN} $$  
  Показывает, какую долю реальных объектов модель обнаружила.

- **FDR (False Discovery Rate):**  
  $$ FDR = \frac{FP}{TP + FP} $$  
  Доля ложных детекций среди всех предсказанных объектов.

### Результаты на видеопоследовательности MOV03478
| Модель       | TPR (Полнота) | FDR   | Скорость (CPU) | Комментарий |
|--------------|--------------|-------|----------------|----------------------------------------------------------|
| MobileNet-SSD| 0.755        | 0.019 | Высокая        | Быстрая работа, умеренное количество ложных срабатываний |
| YOLOv3       | 0.979        | 0.180 | Средняя        | Лучшая полнота, меньше пропусков объектов                |

**Выводы по моделям:**  
MobileNet-SSD подходит для задач, где важна скорость и минимум ложных тревог. YOLOv3 даёт наивысшую полноту и рекомендуется, когда критично обнаружить как можно больше объектов.

---
## Инструкция по запуску

### Требования
- Python 3.8+
- OpenCV (`pip install opencv-python`)
- NumPy

### Команды запуска

**С визуализацией результатов (рекомендуется для демонстрации):**
```bash
python main.py --data_path data/MOV03478 --model ssd --display
python main.py --data_path data/MOV03478 --model yolo --display
```

**Без визуализации (только расчёт и вывод метрик):**
```bash
python main.py --data_path data/MOV03478 --model ssd
python main.py --data_path data/MOV03478 --model yolo
```

### Параметры командной строки
- `--data_path` — путь к папке с кадрами и файлом `mov03478.txt`.
- `--model` — `ssd` или `yolo`.
- `--display` — включить окно с отрисовкой рамок (опционально).

### Визуализация
- Зелёные рамки — ground truth (метка "CAR" над рамкой).
- Цветные рамки — предсказания модели (метка с классом и уверенностью внутри рамки).

Приложение полностью соответствует заданию, использует только OpenCV DNN и демонстрирует работу двух разных архитектур детектирования объектов.