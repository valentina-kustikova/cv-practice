# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

## Алгоритмы детектирования транспортных средств

### Алгоритм YOLOv4

**Процесс детектирования:**
1. **Предобработка изображения**
   - Изменение размера до 416x416 пикселей
   - Нормализация значений пикселей
   - Конвертация изображения в 4мерный тензор (blob)

2. **Прямое распространение через сеть**
   - Извлечение признаков через CSPDarknet53
   - Предсказание bounding boxes и классов на разных масштабах

3. **Постобработка**
   - Выбор класса детектированного объекта по наибольшей уверенности
   - Фильтрация детекций по порогу уверенности
   - Применение Non-Maximum Suppression (NMS) для устранения дублирующих bounding boxes
   - Масштабирование координат обратно к исходному размеру изображения

### Алгоритм SSD MobileNet

**Процесс детектирования:**
1. **Предобработка изображения**
   - Изменение размера до 600x600 пикселей
   - Конвертация изображения в 4мерный тензор (blob)

2. **Извлечение признаков**
   - Глубинные separable свертки для эффективного извлечения признаков
   - Многоуровневое детектирование на разных feature maps

3. **Постобработка**
   - Фильтрация по порогу уверенности
   - Применение NMS для устранения дубликатов
   - Масштабирование координат обратно к исходному размеру изображения

### Алгоритм Faster R-CNN

**Процесс детектирования:**
1. **Предобработка изображения**
   - Изменение размера до 300x300 пикселей
   - Конвертация изображения в 4мерный тензор (blob)

2. **Генерация регионов интереса**
   - RPN генерирует candidate bounding boxes
   - Отбор наиболее перспективных регионов

3. **Постобработка**
   - Фильтрация по порогу уверенности
   - Применение NMS для устранения дубликатов
   - Масштабирование координат обратно к исходному размеру изображения

---

## Программная реализация

### Структура классов:

- **BaseDetector** - базовый класс, содержащий общую логику для всех детекторов
- **YOLODetector** - реализация алгоритма YOLOv4
- **SSDMobileNetDetector** - реализация алгоритма SSD MobileNet
- **FasterRCNNDetector** - реализация алгоритма Faster R-CNN
- **VehicleDetectorFactory** - фабрика для создания детекторов
- **DetectionEvaluator** - класс для оценки качества детектирования
- **AnnotationLoader** - класс для загрузки аннотаций
- **VehicleDetectionApp** - основной класс приложения

### Основные модули:

- `base_struct.py` - базовые классы и структуры данных (Detection, ModelConfig, BaseDetector) 
- `yolo_detector.py, mobilenet_detector.py, rcnn_detector.py` - реализации конкретных детекторов (YOLO, SSD MobileNet, Faster R-CNN)
- `detector_factory.py` - фабрика для создания детекторов
- `evaluator.py` - класс для оценки качества детектирования
- `annotation_loader.py` - класс для работы с аннотациями
- `app.py` - основной класс приложения
- `main.py` - основной скрипт для запуска приложения

### Входные параметры приложения:

- `--images` - путь к директории с изображениями (обязательный параметр)
- `--annotations` - путь к файлу с аннотациями (обязательный параметр)
- `--model` - алгоритм детектирования: yolo, mobilenet или rcnn (обязательный параметр)
- `--confidence` - порог уверенности для детекций (по умолчанию: 0.5)
- `--no-display` - отключить отображение результатов в реальном времени
- `--show-ground-truth` - отображать ground truth bounding boxes

### Выходные данные:

- Детекции транспортных средств в реальном времени
- Метрики качества: True Positive Rate (TPR) и False Discovery Rate (FDR)
- Визуализация bounding boxes с уверенностью
- Статистика по времени обработки

---

## Методы классов

### BaseDetector

**Основные методы:**
- `preprocess` - предобработка изображения для нейронной сети
- `postprocess` - абстрактный метод для постобработки выходов сети
- `_apply_nms` - применение Non-Maximum Suppression для фильтрации дубликатов
- `detect` - основной метод для детектирования объектов на изображении

### YOLODetector

**Основные методы:**
- `postprocess` - обработка выходов YOLO сети, преобразование координат, фильтрация по уверенности

### SSDMobileNetDetector

**Основные методы:**
- `postprocess` - обработка выходов SSD сети, извлечение bounding boxes и классов

### FasterRCNNDetector

**Основные методы:**
- `postprocess` - обработка выходов Faster R-CNN сети, работа с регионами интереса

### VehicleDetectorFactory

**Основные методы:**
- `get_available_models` - возвращает информацию о доступных моделях
- `create_detector` - создает экземпляр детектора по указанному типу

### DetectionEvaluator

**Основные методы:**
- `calculate_iou` - вычисление Intersection over Union для двух bounding boxes
- `evaluate_frame` - оценка качества детектирования для одного кадра
- `get_metrics` - получение агрегированных метрик качества

### AnnotationLoader

**Основные методы:**
- `_load_annotations` - загрузка аннотаций из файла
- `get_ground_truth` - получение ground truth bounding boxes для конкретного изображения

### VehicleDetectionApp

**Основные методы:**
- `draw_detections` - отрисовка bounding boxes детекций на изображении
- `draw_ground_truth` - отрисовка ground truth bounding boxes
- `display_metrics` - отображение метрик качества на изображении
- `run` - основной метод запуска приложения

---

## Метрики оценки качества

### True Positive Rate (TPR)
- Показывает, какая доля реальных объектов была правильно детектирована
- `TPR = True Positives / (True Positives + False Negatives)`

### False Discovery Rate (FDR)
- Покажает, какая доля детекций является ложными срабатываниями
- `FDR = False Positives / (True Positives + False Positives)`