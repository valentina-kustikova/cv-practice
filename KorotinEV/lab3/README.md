# Практическая работа №3. Классификация изображений с использованием библиотеки OpenCV

## Алгоритм "Мешок слов" для классификации изображений

### Алгоритм обучения:

1. **Извлечение локальных признаков** со всех обучающих изображений
   - Находим характерные точки на изображении
   - Для каждой точки вычисляем дескриптор (числовой вектор, описывающий локальную область)

2. **Построение словаря визуальных слов**
   - Собираем все дескрипторы со всех изображений
   - Кластеризуем дескрипторы на указанное число кластеров
   - Центры кластеров становятся "визуальными словами"

3. **Кодирование изображений**
   - Для каждого изображения находим, к каким визуальным словам принадлежат его дескрипторы
   - Строим гистограмму частот визуальных слов: сколько дескрипторов попало в каждый кластер, нормализуем её

4. **Обучение классификатора**
   - Используем полученные гистограммы как признаки для классификатора
   - Обучаем классификатор на этих признаках

### Алгоритм использования:

1. Из каждого нового изображения извлекаем локальные признаки
   - Находим ключевые точки и вычисляем дескрипторы

2. Преобразуем изображение в гистограмму
   - Для каждого дескриптора находим, к каким визуальным словам принадлежат его дескрипторы
   - Строим и нормализуем гистограмму

3. Классифицируем изображение
   - Подаём гистограмму в обученный классификатор для получения предсказания класса

---

## Алгоритм нейронной сети VGG16

### Алгоритм обучения:

1. **Подготовка модели для работы с нашими данными**
   - Возьмём модель, обученную на ImageNet
   - Убераем последние слои (классификаторы ImageNet)
   - Сделаем все слои неизменяемыми, это позволит использовать уже обученные признаки
   - Добавляем свои слои поверх имеющихся

2. **Подготовка данных**
   - Преобразуем все изображения к размеру 224x224 пикселей
   - Конвертирем изображения в формат RGB и нормализуем значения пикселей

3. **Обучение модели**
   - Обучаем добавленные нами в имеющуюся модель слои на наших данных

### Алгоритм использования:

1. **Предобработка новых изображений**
   - Преобразуем все изображения к размеру 224x224 пикселей
   - Конвертирем изображения в формат RGB и нормализуем значения пикселей

2. **Классификация изображения**
   - Пропускаем изображение через замороженные и добавленные нами слои
   - Получаем вероятности принадлежности каждого изображения к каждому классу
   - Выбираем класс с максимальной вероятностью
   - Возвращаем предсказание и вероятность

---

## Программная реализация

### Структура классов:

- **BaseClassifier** - базовый класс, содержащий общую логику для всех классификаторов
- **BOWClassifier** - реализация алгоритма "Мешок слов" 
- **CNNClassifier** - реализация нейронной сети на основе VGG16

### Основные модули:

- `base_classifier.py` - базовый класс с общими методами
- `bow_classifier.py` - классификатор на основе метода "Мешок слов"
- `cnn_classifier.py` - классификатор на основе сверточной нейронной сети  
- `main.py` - основной скрипт для запуска приложения

### Входные параметры приложения:

- `--data_dir` - путь к директории с изображениями (по умолчанию: ./NNClassification)
- `--train_file` - путь к файлу со списком обучающих изображений (по умолчанию: train_test_split/train.txt)
- `--test_file` - путь к файлу со списком тестовых изображений (по умолчанию: train_test_split/test.txt)
- `--algorithm` - алгоритм классификации: bow (мешок слов) или cnn (нейронная сеть)
- `--clusters` - количество кластеров для метода мешок слов (по умолчанию: 100)
- `--mode` - режим работы: train (обучение), test (тестирование), both (обучение и тестирование), visualize (визуализация SIFT)
- `--model_dir` - директория для сохранения/загрузки моделей (по умолчанию: models)
- `--batch_size` - размер батча для CNN (по умолчанию: 16)
- `--epochs` - количество эпох для CNN (по умолчанию: 5)
- `--learning_rate` - скорость обучения для CNN (по умолчанию: 0.001)
- `--dropout_rate` - dropout rate для CNN (по умолчанию: 0.5)
- `--image_size` - размер изображения (ширина высота) (по умолчанию: 224 224)
- `--image_path` - путь к изображению для визуализации SIFT дескрипторов
- `--output_path` - путь для сохранения изображения с SIFT дескрипторами

### Выходные данные:

- Обученные модели сохраняются в указанную директорию
- Accuracy на обучающей и тестовой выборках
- Детальный отчет классификации с метриками precision, recall, f1-score
- Для режима visualize - изображения с отмеченными ключевыми точками

---

## Методы классов

### BaseClassifier

**Основные методы:**
- `detect_label_from_path` - определяет метку класса из пути к файлу
- `load_data` - загружает данные из файла со списком изображений
- `save_model` - сохраняет модель в указанную директорию
- `load_model` - загружает модель из указанной директории
- `train` - абстрактный метод для обучения (реализуется в дочерних классах)
- `test` - абстрактный метод для тестирования (реализуется в дочерних классах)

### BOWClassifier

**Основные методы:**
- `extract_features` - извлекает SIFT-дескрипторы из изображения
- `build_vocabulary` - строит словарь визуальных слов с помощью K-means
- `descr_to_histogram` - преобразует дескрипторы в гистограмму
- `train` - обучает модель BOW на предоставленных данных
- `test` - тестирует модель на предоставленных данных
- `visualize_sift` - визуализирует SIFT-дескрипторы на изображении

### CNNClassifier

**Основные методы:**
- `create_cnn_model` - создает модель CNN на основе VGG16 с transfer learning
- `preprocess_image_cnn` - предобрабатывает изображение для CNN
- `train` - обучает CNN модель на предоставленных данных
- `test` - тестирует CNN модель на предоставленных данных

### Вспомогательные функции

- `create_classifier` - фабричная функция для создания классификаторов
- `visualize_sift_features` - функция для визуализации SIFT-дескрипторов


