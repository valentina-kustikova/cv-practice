# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

## Цель работы

Разработать приложение для детектирования транспортных средств на видеопоследовательности с использованием
предварительно обученных нейронных сетей из "зоопарка" моделей OpenCV (OpenCV Model Zoo). Приложение должно поддерживать
иерархию классов детекторов, обеспечивать расчет метрик качества (TPR, FDR) в реальном времени путем сравнения с
эталонной разметкой (Ground Truth) и визуализировать результаты.

---

## Структура проекта

```
BurykinMI/
└── lab2/
    ├── detectors.py                   # Иерархия классов детекторов (SSD, YOLO)
    ├── utils.py                       # Вспомогательные функции (метрики, парсинг GT)
    ├── main.py                        # Точка входа: инициализация, цикл обработки, визуализация
    ├── README.md                      # Отчет о работе
    ├── data/
    │   └── MOV03478/                  # Набор кадров и файл разметки
    │       ├── mov03478.txt
    │       ├── 000000.jpg
    │       └── ...
    └── models/                        # Веса и конфигурации нейросетей
        ├── ssd/
        │   ├── MobileNetSSD_deploy.prototxt.txt
        │   └── MobileNetSSD_deploy.caffemodel
        └── yolo/
            ├── yolov3.cfg
            ├── yolov3.weights
            └── coco.names
```

---

## Архитектура приложения

Приложение спроектировано с соблюдением принципов ООП и модульности (Separation of Concerns). Код разделен на логические
блоки:

### Основные модули

1. **`detectors.py` (Model Layer)**:
    * Содержит абстрактный базовый класс `BaseDetector`, определяющий интерфейс (`preprocess`, `postprocess`, `detect`).
    * Реализует конкретные стратегии детектирования:
        * `SSDDetector`: Работает с моделями формата Caffe (MobileNet-SSD).
        * `YOLODetector`: Работает с моделями формата Darknet (YOLOv3).
    * Инкапсулирует логику цветовой маркировки классов.

2. **`utils.py` (Utility Layer)**:
    * `Metrics`: Класс для накопления статистики (True Positives, False Positives, False Negatives) и расчета метрик.
    * `compute_iou`: Математическое ядро для оценки перекрытия рамок.
    * `parse_ground_truth`: Парсер текстовой разметки, преобразующий её в удобную структуру данных.

3. **`main.py` (Application Layer)**:
    * Фасад приложения, объединяющий загрузку данных, инициализацию выбранной модели и цикл визуализации.

---

## Описание реализованных алгоритмов

Для работы используется модуль `cv2.dnn`. Реализована поддержка двух архитектур:

### 1. MobileNet-SSD (Single Shot Detector)

Легковесная модель, ориентированная на мобильные устройства.

* **Предобработка (`blobFromImage`):**
    * Размер входа: **300x300**.
    * Вычитание среднего (Mean subtraction): `(127.5, 127.5, 127.5)`.
    * Масштабирование (Scale factor): `0.007843` (прибл. `1/127.5`).
* **Постобработка:**
    * Фильтрация по порогу уверенности (`conf_threshold`).
    * Отбор классов, соответствующих транспорту (в датасете VOC: bus, car, motorbike, train).

### 2. YOLOv3 (You Only Look Once)

Более глубокая и мощная архитектура (Darknet-53).

* **Предобработка (`blobFromImage`):**
    * Размер входа: **416x416** (для повышения точности).
    * Масштабирование: `1/255.0` (нормализация [0, 1]).
    * SwapRB: `True` (конвертация BGR -> RGB).
* **Постобработка:**
    * Выбор класса с максимальной вероятностью для каждого бокса.
    * Применение **NMS (Non-Maximum Suppression)** для устранения дублирующихся рамок.
    * Отбор классов COCO: car, motorbike, bus, train, truck.

---

## Оценка качества (Метрики)

Сравнение предсказаний с эталонной разметкой производится на основе метрики **IoU (Intersection over Union)** с порогом
0.5.

### Используемые показатели:

1. **TPR (True Positive Rate) / Полнота / Recall**:
   $$ TPR = \frac{TP}{TP + FN} $$
   Показывает долю реально существующих объектов, которые модель смогла обнаружить.

2. **FDR (False Discovery Rate)**:
   $$ FDR = \frac{FP}{TP + FP} $$
   Показывает долю ложных срабатываний среди всех обнаруженных объектов (сколько "мусора" нашла модель).

### Результаты экспериментов

Тестирование проводилось на видеопоследовательности `MOV03478`.

| Модель   | TPR (Полнота) | FDR (Ложные тревоги) | Скорость работы | Характеристика                                                                                       |
|----------|---------------|----------------------|-----------------|------------------------------------------------------------------------------------------------------|
| **SSD**  | ~0.746        | ~0.034               | Высокая         | Высокая точность (Precision), мало ложных срабатываний, но пропускает сложные объекты.               |
| **YOLO** | ~0.938        | ~0.219               | Низкая (на CPU) | Высочайшая полнота (находит почти всё), но склонна к ложным срабатываниям и требует больше ресурсов. |

**Выводы:**

* **SSD** предпочтительна для систем реального времени на слабых устройствах, где критично отсутствие ложных тревог.
* **YOLO** показывает лучшие результаты там, где недопустимо пропустить объект, и есть вычислительные мощности для
  фильтрации результатов.

---

## Инструкция по запуску

### Запуск приложения

Основной скрипт `main.py` принимает параметры командной строки.

**Запуск с моделью SSD:**

```bash
python main.py --model ssd --frames_dir data/MOV03478 --gt_file data/MOV03478/mov03478.txt
```

**Запуск с моделью YOLO:**

```bash
python main.py --model yolo --frames_dir data/MOV03478 --gt_file data/MOV03478/mov03478.txt
```

### Параметры:

* `--model`: выбор архитектуры (`ssd` или `yolo`).
* `--frames_dir`: путь к папке с кадрами (jpg).
* `--gt_file`: путь к текстовому файлу разметки.

### Управление во время работы:

* **ESC**: Выход из приложения.
* **Пробел (Space)**: Пауза / Продолжить воспроизведение.

### Визуализация:

* **Цветная рамка (текст внутри)**: Предсказание нейросети. Цвет зависит от класса объекта.
* **Зеленая рамка (текст снаружи "GT")**: Эталонная разметка.
* **Инфо-панель**: Вверху окна отображается текущий номер кадра и накопленные метрики TPR/FDR.
