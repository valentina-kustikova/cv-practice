# Практическая работа №2  
**Детектирование объектов на изображениях с использованием библиотеки OpenCV**

---

## Цель работы

Разработать приложение для детектирования транспортных средств на видеопоследовательности с использованием
предварительно обученных нейронных сетей из «зоопарка» моделей OpenCV (OpenCV Model Zoo).  
Приложение должно поддерживать иерархию классов детекторов, обеспечивать расчет метрик качества
(**TPR / Recall** и **FDR**) в процессе обработки кадров путем сравнения с эталонной разметкой
(Ground Truth), а также визуализировать результаты детектирования.

---

## Структура проекта
````
lab2/
    ├── detectors.py                   
    ├── utils.py                       
    ├── main.py                       
    ├── README.md                      
    ├── data/
    │   
    └── models/                        
        ├── ssd/
        │   ├── MobileNetSSD_deploy.prototxt.txt
        │   └── MobileNetSSD_deploy.caffemodel
        └── yolo/
            ├── yolov3.cfg
            ├── yolov3.weights
            └── coco.names
````


---

## Архитектура приложения

Приложение реализовано с соблюдением принципов объектно-ориентированного программирования и модульности
(Separation of Concerns). Логика детектирования, вычисления метрик и пользовательского интерфейса разделена
по отдельным модулям.

### Основные модули

### 1. `detectors.py` — слой моделей (Model Layer)

Модуль содержит иерархию классов детекторов объектов.

- **`ObjectDetectionModel`** — абстрактный базовый класс, определяющий общий интерфейс:
  - `prepare_image()` — предобработка изображения;
  - `process_output()` — постобработка выходов сети;
  - `detect_objects()` — полный цикл детектирования.
- Реализованы конкретные детекторы:
  - **`SSDMobileNetDetector`** — детектор на основе MobileNet-SSD (Caffe);
  - **`YOLOv3Detector`** — детектор на основе YOLOv3 (Darknet).
- Инкапсулирована логика фильтрации по порогу уверенности, выбор классов транспорта и цветовая маркировка
  объектов.

---

### 2. `utils.py` — вспомогательный модуль (Utility Layer)

Модуль реализует вычислительную и сервисную логику:

- **`calculate_overlap_ratio`** — вычисление метрики IoU (Intersection over Union);
- **`DetectionEvaluator`** — класс для накопления статистики:
  - True Positives (TP),
  - False Positives (FP),
  - False Negatives (FN),
  и расчета метрик Recall (TPR) и FDR;
- **`load_annotation_data`** — загрузка и парсинг эталонной разметки из текстового файла.

---

### 3. `main.py` — прикладной уровень (Application Layer)

Основной управляющий модуль приложения:

- обработка аргументов командной строки;
- инициализация выбранного детектора;
- загрузка кадров и аннотаций;
- основной цикл обработки видеопоследовательности;
- визуализация результатов и вывод итоговых метрик.

---

## Описание реализованных алгоритмов

Для детектирования объектов используется модуль **`cv2.dnn`** библиотеки OpenCV.  
Поддерживаются две архитектуры нейронных сетей.

---

### 1. MobileNet-SSD (Single Shot Detector)

Легковесная архитектура, ориентированная на высокую скорость работы.

**Предобработка изображения:**
- размер входного изображения: **300 × 300**;
- масштабирование: `0.007843` (≈ 1 / 127.5);
- вычитание среднего значения: `(127.5, 127.5, 127.5)`.

**Постобработка:**
- фильтрация по порогу уверенности (`confidence_threshold`);
- отбор классов транспортных средств (VOC):  
  *bus, car, motorbike, train*.

---

### 2. YOLOv3 (You Only Look Once)

Более глубокая и точная архитектура, требующая больших вычислительных ресурсов.

**Предобработка изображения:**
- размер входа: **416 × 416**;
- нормализация значений пикселей в диапазон `[0, 1]`;
- преобразование цветового пространства BGR → RGB.

**Постобработка:**
- выбор класса с максимальной вероятностью;
- фильтрация по порогу уверенности;
- применение **Non-Maximum Suppression (NMS)** для удаления дублирующихся рамок;
- отбор классов транспорта из датасета COCO:  
  *car, motorbike, bus, train, truck*.

---

## Оценка качества детектирования

Сравнение результатов детектирования с эталонной разметкой выполняется на основе метрики **IoU**
с порогом совпадения **0.5**.

### Используемые метрики

1. **TPR (True Positive Rate) / Recall / Полнота**
\[
TPR = \frac{TP}{TP + FN}
\]

Показывает долю реально присутствующих объектов, которые были корректно обнаружены моделью.

2. **FDR (False Discovery Rate)**
\[
FDR = \frac{FP}{TP + FP}
\]

Характеризует долю ложных срабатываний среди всех обнаруженных объектов.

Метрики накапливаются по всем обработанным кадрам и отображаются в режиме реального времени.

---

## Инструкция по запуску

### Требования

- Python 3.8+
- OpenCV (cv2) с поддержкой `dnn`
- NumPy

Установка зависимостей:
```bash
pip install opencv-python numpy
```
## Запуск приложения

### Использование SSD (по умолчанию):

````bash
python main.py --model ssd
````

### Использование YOLOv3:

````bash
python main.py --model yolo
````