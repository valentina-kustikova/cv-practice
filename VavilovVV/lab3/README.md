# Практическая работа №3. Классификация изображений с использованием библиотеки OpenCV

Разработано приложение `lab3.py` для классификации изображений трех достопримечательностей Нижнего Новгорода: **`01_NizhnyNovgorodKremlin`**, **`04_ArkhangelskCathedral`**, **`08_PalaceOfLabor`**. Приложение поддерживает два алгоритма классификации: **"Мешок Слов" (Bag-of-Words, BoW)** с использованием **OpenCV** и **Support Vector Classifier (SVC)**, а также нейронную сеть на основе **Transfer Learning (MobileNetV2)** с использованием **PyTorch**.

-----

## 1\. Структура и Входные Параметры

Приложение реализовано в виде нескольких классов, которые разделены по файлам `base_classifier.py`, `bow_classifier.py`, `cnn_classifier.py`. Также существует главный исполняемый файл `lab3.py`. Запуск происходит из командной строки.

| Аргумент | Тип | Описание | Значение по умолчанию |
| :--- | :--- | :--- | :--- |
| `--data-dir` | `str` | **Обязательный.** Путь к корневой директории с данными. | - |
| `--train-file` | `str` | **Обязательный.** Путь к файлу со списком тренировочных изображений (относительно `--data-dir`). | - |
| `--test-file` | `str` | **Обязательный.** Путь к файлу со списком тестовых изображений (относительно `--data-dir`). | - |
| `--model-dir` | `str` | Папка для сохранения моделей. | `models` |
| `--mode` | `str` | **Обязательный.** Режим работы: `train`, `test`, `train,test`, `visualize`. | - |
| `--algorithm` | `str` | **Обязательный.** Используемый алгоритм: `bow` или `nn`. | - |
| `--classes` | `list` | Список имен классов. | `['01_Kremlin', '04_Cathedral', '08_Palace']` (Сокращено для краткости) |

### Параметры, специфичные для алгоритмов

| Аргумент | Алгоритм | Описание | Значение по умолчанию |
| :--- | :--- | :--- | :--- |
| `--k` | BoW | Размер словаря (кол-во кластеров **$K$-Means**). | `500` |
| `--detector` | BoW | Детектор ключевых точек. Выбор: `sift`, `orb`. | `sift` |
| `--svm-kernel` | BoW | Ядро SVC. | `linear` |
| `--epochs` | NN | Количество эпох обучения. | `20` |
| `--lr` | NN | Скорость обучения. | `0.0001` |
| `--batch-size` | NN | Размер батча. | `32` |
| `--no-pretrained` | NN | Флаг: не использовать предобученные веса ImageNet. | **Используются** (`dest="pretrained"`) |

-----

## 2\. Запуск Скрипта (Bash)

Запуск осуществляется через файл `lab3.py`. Примеры предполагают, что данные находятся в папке `data/`, а файлы со списками — `data/train.txt` и `data/test.txt`.

### 2.1. Обучение и Тестирование BoW

Используется детектор **SIFT**, словарь размером **$K=500$** и линейный **SVC**.

```bash
# Обучение и тестирование BoW
python lab3.py --data-dir data --train-file train.txt --test-file test.txt --mode train,test --algorithm bow --k 500 --detector sift

# Только тестирование BoW (требует ранее обученной модели в models/bow_model.joblib)
python lab3.py --data-dir data --train-file train.txt --test-file test.txt --mode test --algorithm bow
```

### 2.2. Обучение и Тестирование NN (MobileNetV2)

Используется предобученная модель **MobileNetV2** с обучением в течение **20 эпох** и размером батча **32**.

```bash
# Обучение и тестирование MobileNetV2
python lab3.py --data-dir data --train-file train.txt --test-file test.txt --mode train,test --algorithm nn --epochs 20 --batch-size 32

# Только тестирование NN (требует ранее обученной модели в models/nn_model.pth)
python lab3.py --data-dir data --train-file train.txt --test-file test.txt --mode test --algorithm nn
```

### 2.3. Визуализация Ключевых Точек

Запускает SIFT-детектор и сохраняет изображения с отмеченными ключевыми точками в папку `keypoint_visualizations/`.

```bash
# Визуализация ключевых точек SIFT
python lab3.py --data-dir data --train-file train.txt --test-file test.txt --mode visualize --algorithm bow --detector sift
```

-----

## 3\. Алгоритмы Классификации

### 3.1. Алгоритм "Мешок Слов" (Bag-of-Words, BoW)

Использует **SIFT** для извлечения дескрипторов, **$K$-Means (K=500)** для построения словаря, **StandardScaler** для нормализации гистограмм и **SVC (линейное ядро)** для классификации.

### 3.2. Нейросетевой Классификатор (CNN)

Используется подход **переноса обучения** с базовой моделью **MobileNetV2**, предобученной на ImageNet.

1.  **Модификация:** Последний полносвязный слой (`self.model.classifier[1]`) заменяется на новый слой `nn.Linear` с **3 выходами** (по числу классов).
2.  **Аугментация:** Для тренировки используются `RandomRotation(20)` и `RandomHorizontalFlip`.
3.  **Обучение:** $\approx 20$ эпох, оптимизатор **AdamW**, функция потерь **CrossEntropyLoss**.

-----

## 4\. Результаты Классификации и Выводы

Результаты тестов получены на тестовой выборке с **44 изображениями** и отражают производительность моделей с параметрами по умолчанию (**BoW: $K=500$, SIFT, SVC**; **NN: MobileNetV2, 20 эпох**).

### 4.1. Результаты BoW (K=500, SIFT)

| Класс | Precision (Точность) | Recall (Полнота) | F1-Score | Support |
| :--- | :--- | :--- | :--- | :--- |
| **01\_NizhnyNovgorodKremlin** | **1.00** | **1.00** | **1.00** | 18 |
| **04\_ArkhangelskCathedral** | 0.90 | **1.00** | 0.95 | 9 |
| **08\_PalaceOfLabor** | **1.00** | 0.94 | 0.97 | 17 |
| **Macro Avg** | 0.97 | **0.98** | 0.97 | 44 |
| **Accuracy** | - | - | - | **0.9773** |

#### Вывод по BoW

  * **Общее качество:** Увеличение размера словаря (K=500) позволило значительно улучшить метрики. **Общая точность (Accuracy) составила 97.73%**.
  * **Сильные стороны:** Класс `01_NizhnyNovgorodKremlin` классифицируется идеально. `08_PalaceOfLabor` имеет идеальный **Precision (1.00)**.
  * **Слабые стороны:** Класс `04_ArkhangelskCathedral` имеет самый низкий **Precision (0.90)**, что указывает на то, что **10%** предсказаний этого класса на самом деле были ошибочными.

### 4.2. Результаты CNN (MobileNetV2, 20 эпох)

| Класс | Precision (Точность) | Recall (Полнота) | F1-Score | Support |
| :--- | :--- | :--- | :--- | :--- |
| **01\_NizhnyNovgorodKremlin** | **1.00** | **1.00** | **1.00** | 18 |
| **04\_ArkhangelskCathedral** | **1.00** | **1.00** | **1.00** | 9 |
| **08\_PalaceOfLabor** | **1.00** | **1.00** | **1.00** | 17 |
| **Macro Avg** | **1.00** | **1.00** | **1.00** | 44 |
| **Accuracy** | - | - | - | **1.0000** |

#### Вывод по CNN

  * **Общее качество:** Нейросетевая модель с переносом обучения достигла **идеальной точности 100% (Test Accuracy: 1.0)** на тестовой выборке.
  * **Заключение:** Использование **MobileNetV2** с переносом обучения полностью решило задачу классификации на данном тестовом наборе, показав **превосходный результат** по всем метрикам.

### Общий Вывод

| Метод | Test Accuracy | Macro Avg F1-Score |
| :--- | :--- | :--- |
| **BoW ($K=500$)** | 0.9773 | 0.97 |
| **CNN (MobileNetV2)** | **1.0000** | **1.00** |

Несмотря на значительное улучшение результата для BoW-алгоритма (до 97.73%), **сверточная нейронная сеть (CNN)** с использованием переноса обучения по-прежнему демонстрирует **наилучшую производительность** (100% точность), что делает ее рекомендуемым подходом для данной задачи.

-----
