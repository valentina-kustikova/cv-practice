# Практическая работа №3. Классификация изображений с использованием библиотеки OpenCV

## Алгоритм "Мешок слов" для классификации изображений

### Алгоритм обучения:

1. **Извлечение локальных признаков** со всех обучающих изображений
   - Используется детектор SIFT для нахождения характерных точек на изображении
   - Для каждой точки вычисляется дескриптор (числовой вектор, описывающий локальную область)

2. **Построение словаря визуальных слов**
   - Собираются все дескрипторы со всех изображений
   - Кластеризуются с помощью KMeans на указанное число кластеров
   - Центры кластеров становятся "визуальными словами"

3. **Кодирование изображений**
   - Для каждого изображения находятся, к каким визуальным словам принадлежат его дескрипторы
   - Строится гистограмма частот визуальных слов: сколько дескрипторов попало в каждый кластер
   - Гистограмма нормализуется

4. **Обучение классификатора**
   - Используются полученные гистограммы как признаки для классификатора
   - Обучается SVM (машина опорных векторов) с RBF-ядром на этих признаках

### Алгоритм использования:

1. Из каждого нового изображения извлекаются локальные признаки
   - Находятся ключевые точки и вычисляются дескрипторы с помощью SIFT

2. Преобразование изображения в гистограмму
   - Для каждого дескриптора определяется, к каким визуальным словам он принадлежит (через KMeans)
   - Строится и нормализуется гистограмма частот визуальных слов

3. Классификация изображения
   - Гистограмма подается в обученный SVM-классификатор
   - Получается предсказание класса и уверенность в предсказании

---

## Алгоритм нейронной сети ResNet50

### Алгоритм обучения:

1. **Подготовка модели для работы с нашими данными**
   - Используется предобученная модель ResNet50 с весами ResNet50_Weights.IMAGENET1K_V1
   - Замораживаются веса всех слоев (используются уже обученные признаки)
   - Заменяется последний слой (классификатор) на последовательность новых слоев:
     - Dropout(0.5)
     - Linear(входной_размер, 512)
     - ReLU
     - Dropout(0.3)
     - Linear(512, количество_классов)

2. **Подготовка данных**
   - Все изображения преобразуются к размеру 224x224 пикселей
   - Применяется аугментация данных (горизонтальный флип, повороты, изменение яркости)
   - Изображения конвертируются в формат RGB и нормализуются

3. **Обучение модели**
   - Обучаются только новые слои, добавленные поверх предобученной модели
   - Используется оптимизатор Adam и функция потерь CrossEntropy

### Алгоритм использования:

1. **Предобработка новых изображений**
   - Все изображения преобразуются к размеру 224x224 пикселей
   - Конвертируются в формат RGB и нормализуются

2. **Классификация изображения**
   - Изображение пропускается через предобученные и новые слои
   - Получаются вероятности принадлежности к каждому классу
   - Выбирается класс с максимальной вероятностью
   - Возвращается предсказание и уверенность

---

## Программная реализация

### Структура классов:

- **BagOfWordsClassifier** - реализация алгоритма "Мешок слов" 
- **NeuralNetworkClassifier** - реализация нейронной сети на основе ResNet50

### Основные модули:

- `main.py` - основной скрипт для запуска приложения
- `src/bag_of_words.py` - классификатор на основе метода "Мешок слов"
- `src/neural_network.py` - классификатор на основе нейронной сети  
- `src/utils.py` - вспомогательные функции для работы с данными
- `src/__init__.py` - файл для создания Python-пакета

### Входные параметры приложения:

- `--data_dir` - путь к директории с изображениями
- `--train_split` - путь к файлу со списком обучающих изображений
- `--test_split` - путь к файлу со списком тестовых изображений
- `--mode` - режим работы: train (обучение), test (тестирование), train_test (обучение и тестирование)
- `--algorithm` - алгоритм классификации: bow (мешок слов) или neural_network (нейронная сеть)
- `--bow_k` - количество кластеров для метода мешок слов (по умолчанию: 100)
- `--epochs` - количество эпох для нейронной сети (по умолчанию: 20)
- `--batch_size` - размер батча для нейронной сети (по умолчанию: 32)
- `--model_path` - путь для сохранения/загрузки модели (по умолчанию: model.pth)

### Выходные данные:

- Обученные модели сохраняются в указанный файл
- Выводится точность (accuracy) на обучающей и тестовой выборках
- В файл results.txt записываются использованные параметры и результаты

---

## Методы классов

### BagOfWordsClassifier

**Основные методы:**
- `extract_features` - извлекает SIFT-дескрипторы из изображения
- `build_vocabulary` - строит словарь визуальных слов с помощью K-means
- `create_histogram` - преобразует дескрипторы изображения в гистограмму визуальных слов
- `prepare_data` - готовит данные (гистограммы и метки) для обучения
- `train` - обучает модель BOW на предоставленных данных
- `predict` - предсказывает класс для одного изображения
- `evaluate` - оценивает модель на тестовых данных
- `save_model` - сохраняет обученную модель в файл
- `load_model` - загружает обученную модель из файла

### NeuralNetworkClassifier

**Основные методы:**
- `_build_model` - создает модель ResNet50 с transfer learning и замороженными слоями
- `train` - обучает нейронную сеть на предоставленных данных
- `evaluate` - оценивает нейронную сеть на тестовых данных
- `save_model` - сохраняет обученную модель в файл
- `load_model` - загружает обученную модель из файла

### Вспомогательные функции в utils.py

- `extract_class_name` - извлекает имя класса из пути к файлу
- `load_split_file` - загружает пути к изображениям из файла разбиения
- `load_image_paths` - загружает все пути к изображениям из директории
- `create_class_mapping` - создает отображение между именами классов и индексами

---

## Результаты экспериментов

| Алгоритм | Параметры | Точность (Accuracy) |
|----------|-----------|-------------------|
| Мешок слов | vocab_size=50 | 0.8000 |
| Мешок слов | vocab_size=70 | 0.8462 |
| Нейронная сеть (ResNet50) | epochs=8, batch_size=8 | 0.8769 |
| Нейронная сеть (ResNet50) | epochs=10, batch_size=8 | 0.9385 |
