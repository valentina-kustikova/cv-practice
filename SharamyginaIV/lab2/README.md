# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

## Алгоритм детектирования транспортных средств

### Алгоритм YOLOv3

**Процесс детектирования:**

1. **Предобработка изображения**
   - Изменение размера до 416x416 пикселей
   - Нормализация значений пикселей: `x = x / 255.0`
   - Конвертация изображения в 4-мерный тензор (blob)

2. **Прямое распространение через сеть**
   - Извлечение признаков через Darknet-53
   - Предсказание bounding boxes и классов на разных масштабах (3 различных масштаба)

3. **Постобработка**
   - Для каждой детекции вычисляется уверенность класса: `class_confidence = objectness × class_probability`
   - Выбор класса детектированного объекта: `ĉ = argmax_k p_k`
   - Фильтрация детекций по порогу уверенности: `class_confidence ≥ τ_conf`
   - Преобразование координат из относительного формата (center_x, center_y, width, height) в абсолютные координаты:
     ```
     x_abs = center_x × W_original
     y_abs = center_y × H_original
     w_abs = width × W_original
     h_abs = height × H_original
     ```
   - Конвертация в формат (x1, y1, x2, y2):
     ```
     x1 = x_abs - w_abs/2
     y1 = y_abs - h_abs/2
     x2 = x1 + w_abs
     y2 = y1 + h_abs
     ```
   - Применение Non-Maximum Suppression (NMS) для устранения дублирующих bounding boxes

### Методика оценки качества

Для оценки качества работы детектора применяются показатели TPR (True Positive Rate) и FDR (False Discovery Rate). 
Метрики вычисляются на основе пересечения предсказанных рамок с разметкой (Ground Truth) по критерию IoU (Intersection over Union).

#### Intersection over Union (IoU)

IoU(A,B) = |A ∩ B| / |A ∪ B| = |A ∩ B| / (|A| + |B| - |A ∩ B|)
где:
- `A ∩ B` - площадь пересечения predicted и ground truth bounding boxes
- `A ∪ B` - площадь объединения bounding boxes

#### True Positive Rate (TPR) / Recall

TPR = TP / (TP + FN)

Показывает, какая доля реальных объектов была правильно детектирована

#### False Detection Rate (FDR)

FDR = FP / (TP + FP)
Показывает, какая доля детекций является ложными срабатываниями

#### Критерии классификации:
- **True Positive (TP)**: Детекция считается корректной если `IoU ≥ 0.5` и класс правильный
- **False Positive (FP)**: Детекция с `IoU < 0.5` или неправильным классом
- **False Negative (FN)**: Объект из ground truth не был детектирован

#### Non-Maximum Suppression (NMS)
Алгоритм применяется для устранения дублирующих bounding boxes:
1. Детекции сортируются по уверенности: `detections ← sort(detections, confidence)`
2. Для каждой пары детекций вычисляется IoU
3. Если `IoU(det_i, det_j) > τ_nms`, то менее уверенная детекция удаляется

### Программная реализация

#### Структура классов:
- **ObjectDetector** - базовый класс, содержащий общую логику для всех детекторов
- **YOLOv3Detector** - реализация алгоритма YOLOv3

#### Основные модули:
- `detector_base.py` - базовый класс детектора
- `yolov3_detector.py` - реализация YOLOv3 детектора
- `main.py` - основной скрипт для запуска приложения
- `utils.py` - вспомогательные функции для отрисовки и загрузки данных
- `metrics.py` - реализация метрик оценки качества

#### Входные параметры приложения:
- `--input_dir` - путь к директории с изображениями (обязательный параметр)
- `--model_type` - алгоритм детектирования (yolo, ssd, faster_rcnn) (обязательный параметр)
- `--model_path` - путь к файлу модели (.weights) (обязательный параметр)
- `--config_path` - путь к файлу конфигурации (.cfg) (обязательный параметр)
- `--classes_path` - путь к файлу с именами классов (.names) (обязательный параметр)
- `--labels_path` - путь к файлу с аннотациями (обязательный параметр)
- `--conf_threshold` - порог уверенности для детекций `τ_conf` (по умолчанию: 0.5)
- `--nms_threshold` - порог NMS `τ_nms` (по умолчанию: 0.4)
- `--display` - отображение результатов в реальном времени

#### Выходные данные:
- Детекции транспортных средств на кадрах
- Метрики качества: True Positive Rate (TPR) и False Discovery Rate (FDR)
- Визуализация bounding boxes с уверенностью и метриками на кадре
- Средние метрики по всем обработанным кадрам

### Методы классов

#### ObjectDetector (Базовый класс)
Основные методы:
- `__init__()` - инициализация детектора
- `preprocess()` - предобработка изображения для нейронной сети
- `postprocess()` - постобработка выходов сети
- `detect()` - основной метод для детектирования объектов на изображении
- `get_output_layers()` - получение имен выходных слоев модели

#### YOLOv3Detector
Основные методы:
- `__init__()` - загрузка модели YOLOv3 из файлов конфигурации и весов
- `preprocess()` - предобработка изображения для YOLOv3 (resize, нормализация)
- `postprocess()` - обработка выходов YOLO сети, преобразование координат, фильтрация по уверенности, применение NMS
- `get_output_layers()` - получение имен выходных слоев YOLOv3

#### Вспомогательные функции (utils.py)
- `draw_predictions()` - отрисовка bounding boxes и меток классов на изображении
- `load_ground_truth_labels()` - загрузка ground truth аннотаций из файла
- `get_image_files()` - получение списка файлов изображений из директории

#### Функции оценки качества (metrics.py)
- `calculate_iou()` - вычисление Intersection over Union для двух bounding boxes
- `calculate_tpr_fdr()` - вычисление метрик TPR и FDR для набора детекций

### Метрики качества реализованной модели

#### YOLOv3
- **Average TPR**: 0.919
- **Average FDR**: 0.231

### Выводы

В ходе выполнения работы:

1. Реализована система детекции транспортных средств на изображениях с использованием модели YOLOv3
2. Реализованы алгоритмы предобработки и постобработки для модели YOLOv3
3. Выполнена оценка качества с использованием метрик IoU, TPR, FDR
4. Построена модульная, расширяемая архитектура приложения
5. Обеспечена корректная визуализация результатов и работа с аннотациями

### Запуск программы

```bash
python main.py \
    --input_dir data/images \
    --model_type yolo \
    --model_path models/yolov3.weights \
    --config_path models/yolov3.cfg \
    --classes_path models/coco.names \
    --labels_path data/labels.txt \
    --conf_threshold 0.5 \
    --nms_threshold 0.4 \
    --display
