# Практическая работа №3. Классификация изображений с использованием библиотеки OpenCV

## Описание проекта
Разработано приложение для классификации изображений известных достопримечательностей Нижнего Новгорода:
1. **Нижегородский Кремль**
2. **Дворец труда**  
3. **Архангельский собор**

## Реализованные алгоритмы

### Алгоритм "Мешок слов" для классификации изображений

#### Алгоритм обучения:

**1. Извлечение локальных признаков со всех обучающих изображений**
- Находим характерные точки на изображении с помощью детекторов (SIFT, ORB, AKAZE)
- Для каждой точки вычисляем дескриптор - числовой вектор, описывающий локальную область вокруг точки
- Сохраняем дескрипторы всех изображений для дальнейшей обработки

**2. Построение словаря визуальных слов**
- Собираем все дескрипторы со всех обучающих изображений в один большой набор
- Применяем алгоритм K-means для кластеризации дескрипторов на указанное число кластеров
- Центры полученных кластеров становятся "визуальными словами" нашего словаря

**3. Кодирование изображений**
- Для каждого изображения находим, к каким визуальным словам принадлежат его дескрипторы
- Строим гистограмму частот визуальных слов: подсчитываем сколько дескрипторов попало в каждый кластер
- Нормализуем гистограмму для получения инвариантности к количеству дескрипторов

**4. Обучение классификатора**
- Используем полученные гистограммы как признаковое описание каждого изображения
- Обучаем классификатор (SVM или Random Forest) на этих признаках для распознавания трех классов

#### Алгоритм использования:

**1. Извлечение локальных признаков из нового изображения**
- Находим ключевые точки и вычисляем дескрипторы так же, как при обучении
- Если детектор не находит точек, возвращаем нулевой вектор признаков

**2. Преобразование изображения в гистограмму**
- Для каждого дескриптора находим ближайший визуальный словарь из обученного словаря
- Строим гистограмму распределения дескрипторов по визуальным словам
- Нормализуем гистограмму

**3. Классификация изображения**
- Подаем полученную гистограмму в обученный классификатор
- Получаем предсказание класса и вероятность принадлежности к каждому классу

### Алгоритм нейронной сети с Transfer Learning

#### Алгоритм обучения:

**1. Подготовка модели для работы с нашими данными**
- Берем предобученную модель VGG16, обученную на ImageNet (14 миллионов изображений, 1000 классов)
- Удаляем последние слои классификации, которые были настроены на 1000 классов ImageNet
- Замораживаем веса базовых сверточных слоев, чтобы сохранить уже обученные признаки
- Добавляем свои полносвязные слои для классификации трех классов достопримечательностей

**2. Подготовка данных**
- Преобразуем все изображения к фиксированному размеру 224×224 пикселей
- Конвертируем изображения в формат RGB
- Нормализуем значения пикселей путем деления на 255
- Применяем аугментацию данных для увеличения разнообразия обучающей выборки

**3. Обучение модели**
- Обучаем только добавленные нами слои, веса базовых слоев остаются неизменными
- Используем оптимизатор Adam с настраиваемой скоростью обучения
- Применяем callback-функции для ранней остановки и уменьшения скорости обучения при плато

#### Алгоритм использования:

**1. Предобработка новых изображений**
- Преобразуем изображение к размеру 224×224 пикселей
- Конвертируем в формат RGB и нормализуем значения пикселей
- Добавляем размерность батча для подачи в нейронную сеть

**2. Классификация изображения**
- Пропускаем изображение через замороженные сверточные слои (извлекаем признаки)
- Пропускаем полученные признаки через добавленные полносвязные слои
- Получаем вероятности принадлежности изображения к каждому из трех классов
- Выбираем класс с максимальной вероятностью
- Возвращаем предсказание и уверенность классификации

## Программная реализация

### Структура классов:

**BaseClassifier** - базовый абстрактный класс, содержащий общую логику для всех классификаторов
- Определение меток классов из путей к файлам
- Загрузка данных из файлов со списками изображений
- Сохранение и загрузка метаданных моделей
- Вычисление и отображение метрик качества

**BOWClassifier** - реализация алгоритма "Мешок слов"
- Извлечение локальных признаков с использованием различных детекторов
- Построение словаря визуальных слов методом K-means
- Преобразование изображений в гистограммы
- Обучение классификатора на гистограммаx
- Визуализация ключевых точек на изображениях

**CNNClassifier** - реализация нейронной сети на основе Transfer Learning
- Создание модели на базе предобученных архитектур (VGG16, MobileNetV2, ResNet50)
- Предобработка изображений для подачи в нейронную сеть
- Обучение с использованием аугментации данных
- Визуализация процесса обучения

### Основные модули:

**base_classifier.py** - базовый класс с общими методами для всех классификаторов
**bow_classifier.py** - классификатор на основе метода "Мешок слов"
**cnn_classifier.py** - классификатор на основе сверточной нейронной сети
**main.py** - основной скрипт для запуска приложения и обработки аргументов командной строки

## Входные параметры приложения

### Основные параметры:
- `--data_dir` - путь к директории с изображениями (по умолчанию: `./NNClassification`)
- `--train_file` - путь к файлу со списком обучающих изображений (по умолчанию: `train_test_split/train.txt`)
- `--test_file` - путь к файлу со списком тестовых изображений (по умолчанию: `train_test_split/test.txt`)
- `--algorithm` - алгоритм классификации: `bow` (мешок слов) или `cnn` (нейронная сеть)
- `--mode` - режим работы: `train` (обучение), `test` (тестирование), `both` (обучение и тестирование), `visualize` (визуализация), `single` (предсказание для одного изображения)
- `--model_dir` - директория для сохранения/загрузки моделей (по умолчанию: `models`)

### Параметры для алгоритма "Мешок слов":
- `--clusters` - количество кластеров/визуальных слов (по умолчанию: 200)
- `--detector` - тип детектора: `sift`, `orb` или `akaze` (по умолчанию: `sift`)

### Параметры для нейронной сети:
- `--batch_size` - размер батча для обучения (по умолчанию: 16)
- `--epochs` - количество эпох обучения (по умолчанию: 20)
- `--learning_rate` - скорость обучения (по умолчанию: 0.001)
- `--dropout_rate` - коэффициент dropout для регуляризации (по умолчанию: 0.5)
- `--base_model` - базовая модель для Transfer Learning: `vgg16`, `mobilenetv2` или `resnet50` (по умолчанию: `vgg16`)

### Параметры для визуализации:
- `--image_path` - путь к изображению для визуализации ключевых точек
- `--output_path` - путь для сохранения изображения с визуализированными дескрипторами

### Дополнительные параметры:
- `--use_extra_images` - использовать дополнительные изображения из папки `my_images`
- `--extra_dir` - директория с дополнительными изображениями (по умолчанию: `my_images`)
- `--plot_confusion` - показывать матрицу ошибок после тестирования
- `--plot_history` - показывать графики обучения для нейронной сети
- `--image_size` - размер изображения в формате "ширина высота" (по умолчанию: 224 224)

## Выходные данные

### Режимы обучения и тестирования:
- Обученные модели сохраняются в указанную директорию (`models/`)
- Accuracy (точность) на обучающей и тестовой выборках
- Детальный отчет классификации с метриками: precision, recall, f1-score для каждого класса
- Матрица ошибок (confusion matrix) при использовании флага `--plot_confusion`

### Режим визуализации:
- Изображения с отмеченными ключевыми точками
- Информация о количестве найденных ключевых точек
- Возможность сохранения визуализированных изображений

### Режим предсказания для одного изображения:
- Предсказанный класс достопримечательности
- Уверенность классификации (вероятность)
- Отображение изображения с подписью предсказания

## Методы классов

### BaseClassifier
**Основные методы:**
- `detect_label_from_path()` - определяет метку класса из пути к файлу
- `load_data()` - загружает данные из файла со списком изображений
- `save_model()` - сохраняет модель в указанную директорию
- `load_model()` - загружает модель из указанной директории
- `train()` - абстрактный метод для обучения (реализуется в дочерних классах)
- `test()` - абстрактный метод для тестирования (реализуется в дочерних классах)
- `plot_confusion_matrix()` - визуализирует матрицу ошибок классификации

### BOWClassifier
**Основные методы:**
- `extract_features()` - извлекает локальные признаки (дескрипторы) из изображения
- `build_vocabulary()` - строит словарь визуальных слов с помощью K-means
- `image_to_histogram()` - преобразует дескрипторы изображения в гистограмму
- `train()` - обучает модель "Мешок слов" на предоставленных данных
- `test()` - тестирует модель на предоставленных данных
- `visualize_features()` - визуализирует ключевые точки на изображении
- `predict_single()` - предсказывает класс для одного изображения

### CNNClassifier
**Основные методы:**
- `create_cnn_model()` - создает модель CNN на основе Transfer Learning
- `preprocess_image_cnn()` - предобрабатывает изображение для подачи в нейронную сеть
- `prepare_dataset()` - подготавливает датасет для обучения/тестирования
- `train()` - обучает CNN модель на предоставленных данных
- `test()` - тестирует CNN модель на предоставленных данных
- `predict_single()` - предсказывает класс для одного изображения
- `plot_training_history()` - визуализирует историю обучения модели

## Вспомогательные функции

### Функции в main.py:
- `create_classifier()` - фабричная функция для создания классификаторов в зависимости от выбранного алгоритма
- `visualize_sift_features()` - функция для визуализации ключевых точек на изображении
- `combine_train_files()` - объединяет оригинальный train.txt с дополнительными изображениями
- `test_single_image()` - тестирует классификатор на одном изображении

### Общие утилиты:
- Автоматическое определение метки класса из структуры пути
- Обработка отсутствующих или поврежденных изображений
- Нормализация и масштабирование признаков
- Сохранение и загрузка моделей в стандартных форматах

## Примеры использования

### Базовые команды:
```bash
# Визуализация SIFT-дескрипторов на изображении
python scripts/main.py --mode visualize --image_path "путь/к/изображению.jpg" --detector sift

# Обучение и тестирование модели "Мешок слов"
python scripts/main.py --mode both --algorithm bow --clusters 200 --detector sift

# Обучение и тестирование нейронной сети
python scripts/main.py --mode both --algorithm cnn --epochs 10 --batch_size 8

# Предсказание для одного изображения
python scripts/main.py --mode single --algorithm cnn --image_path "путь/к/изображению.jpg"
